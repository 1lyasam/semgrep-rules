rules:
- id: mongodb-nosqli
  message: Detected non-constant data passed into a NoSQL query using the 'where'
    evaluation operator. If this data can be controlled by an external user, this
    is a NoSQL injection. Ensure data passed to the NoSQL query is not user controllable,
    or properly sanitize the data. Ideally, avoid using the 'where' operator at all
    and instead use the helper methods provided by com.mongodb.client.model.Filters
    with comparative operators such as eq, ne, lt, gt, etc.
  languages:
  - java
  severity: WARNING
  patterns:
  - pattern-either:
    - pattern: (BasicDBObject $QUERY).put("$where", $INPUT);
    - pattern: '(HashMap<String, String> $MAP).put("$where", $INPUT);

        ...

        (BasicDBObject $QUERY).putAll($MAP);

        '
    - pattern: (BasicDBObject $QUERY).append("$where", $INPUT);
    - pattern: new BasicDBObject("$where", $INPUT);
    - pattern: '(HashMap<String, String> $MAP).put("$where", $INPUT);

        ...

        new BasicDBObject($MAP);

        '
    - pattern: '(HashMap<String, String> $MAP).put("$where", $INPUT);

        ...

        String json = new JSONObject($MAP).toString();

        (BasicDBObject $QUERY).parse((String $JSON));

        '
    - pattern: BasicDBObjectBuilder.start().add("$where", $INPUT);
    - pattern: BasicDBObjectBuilder.start().append("$where", $INPUT);
    - pattern: BasicDBObjectBuilder.start("$where", $INPUT);
    - pattern: '(HashMap<String, String> $MAP).put("$where", $INPUT);

        ...

        BasicDBObjectBuilder.start($MAP);

        '
  - pattern-not: (BasicDBObject $QUERY).put("$where", "...");
  - pattern-not: '(HashMap<String, String> $MAP).put("$where", "...");

      ...

      (BasicDBObject $QUERY).putAll($MAP);

      '
  - pattern-not: (BasicDBObject $QUERY).append("$where", "...");
  - pattern-not: new BasicDBObject("$where", "...");
  - pattern-not: '(HashMap<String, String> $MAP).put("$where", "...");

      ...

      new BasicDBObject($MAP);

      '
  - pattern-not: '(HashMap<String, String> $MAP).put("$where", "...");

      ...

      String json = new JSONObject($MAP).toString();

      (BasicDBObject $QUERY).parse((String $JSON));

      '
  - pattern-not: BasicDBObjectBuilder.start().add("$where", "...");
  - pattern-not: BasicDBObjectBuilder.start().append("$where", "...");
  - pattern-not: BasicDBObjectBuilder.start("$where", "...");
  - pattern-not: '(HashMap<String, String> $MAP).put("$where", "...");

      ...

      BasicDBObjectBuilder.start($MAP);

      '
  metadata:
    category: security
    technology:
    - nosql
    - mongodb
    cwe:
    - 'CWE-943: Improper Neutralization of Special Elements in Data Query Logic'
    owasp:
    - A01:2017 - Injection
    - A03:2021 - Injection
    asvs:
      section: 'V5: Validation, Sanitization and Encoding Verification Requirements'
      control_id: 5.3.4 Injection Prevention
      control_url: https://github.com/OWASP/ASVS/blob/master/5.0/en/0x13-V5-Validation-Sanitization-Encoding.md#v53-output-encoding-and-injection-prevention
      version: '5'
    references:
    - https://owasp.org/Top10/A03_2021-Injection
    - https://www.mongodb.com/docs/manual/tutorial/query-documents/
    - https://www.mongodb.com/docs/manual/reference/operator/query/where/
    subcategory:
    - audit
    likelihood: LOW
    impact: HIGH
    confidence: LOW
