rules:
- fix: Psych.safe_load($...ARGS)
  id: bad-deserialization-yaml
  languages:
  - ruby
  message: Unsafe deserialization from YAML. Objects in Ruby can be serialized into
    strings, then later loaded from strings. However, uses of load and object_load
    can cause remote code execution. Loading user input with YAML can potentially
    be dangerous. Use JSON in a secure fashion instead. However, loading YAML from
    a static file is not dangerous and should not be flagged.
  metadata:
    category: security
    cwe: "CWE-16: Configuration"
    references:
    - https://groups.google.com/g/rubyonrails-security/c/61bkgvnSGTQ/m/nehwjA8tQ8EJ
    - https://github.com/presidentbeef/brakeman/blob/main/lib/brakeman/checks/check_deserialize.rb
    technology:
    - ruby
    - yaml
  patterns:
  - pattern: |
      YAML.load($...ARGS)
  - pattern-not: |
      YAML.load(..., safe: true, ...)
  - pattern-not: |
      YAML.load("...", ...)
  - pattern-not-inside: |
      $FILE = File.read("...", ...)
      ...
      YAML.load(..., $FILE, ...)
  - pattern-not-inside: |
      $FILENAME = "..."
      ...
      $FILE = File.read($FILENAME, ...)
      ...
      YAML.load(..., $FILE, ...)
  - pattern-not-inside: |
      YAML.load(..., File.read("...", ...), ...)
  severity: ERROR
