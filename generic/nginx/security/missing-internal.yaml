rules:
- id: missing-internal
  languages:
  - generic
  message: This location block contains a 'proxy_pass' directive but does not contain
    the 'internal' directive. The 'internal' directive restricts access to this location
    to internal requests. Without 'internal', an attacker could use your server for
    server-side request forgeries (SSRF). Include the 'internal' directive in this
    block to limit exposure.
  metadata:
    category: security
    confidence: MEDIUM
    cwe: "CWE-16: Configuration"
    references:
    - https://github.com/yandex/gixy/blob/master/docs/en/plugins/ssrf.md
    - https://nginx.org/en/docs/http/ngx_http_core_module.html#internal
    technology:
    - nginx
  paths:
    include:
    - '*.conf'
    - '*.vhost'
    - sites-available/*
    - sites-enabled/*
  patterns:
  - pattern-inside: |
      location ... {
        ...
        ...
      }
  - pattern-not-inside: |
      location ... {
        ...
        internal;
        ...
      }
  - pattern: proxy_pass ...$...;
  severity: WARNING
