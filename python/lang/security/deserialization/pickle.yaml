rules:
- id: avoid-pickle
  metadata:
    owasp:
    - A08:2017 - Insecure Deserialization
    - A08:2021 - Software and Data Integrity Failures
    cwe:
    - 'CWE-502: Deserialization of Untrusted Data'
    references:
    - https://docs.python.org/3/library/pickle.html
    category: security
    technology:
    - python
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
    - audit
    likelihood: LOW
    impact: MEDIUM
    confidence: LOW
  languages:
    - python
  message: >-
    Avoid using `pickle`, which is known to lead to code execution vulnerabilities.
    When unpickling, the serialized data could be manipulated to run arbitrary code.
    Instead, consider serializing the relevant data as JSON or a similar text-based
    serialization format.
  severity: WARNING
  patterns:
    - pattern-either:
      - pattern: pickle.$FUNC(...)
      - pattern: _pickle.$FUNC(...)
    - pattern-not: pickle.$FUNC("...")
    - pattern-not: _pickle.$FUNC("...")
- id: avoid-cPickle
  metadata:
    owasp:
    - A08:2017 - Insecure Deserialization
    - A08:2021 - Software and Data Integrity Failures
    cwe:
    - 'CWE-502: Deserialization of Untrusted Data'
    references:
    - https://docs.python.org/3/library/pickle.html
    category: security
    technology:
    - python
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
    - audit
    likelihood: LOW
    impact: MEDIUM
    confidence: LOW
  languages:
    - python
  message: >-
    Avoid using `cPickle`, which is known to lead to code execution vulnerabilities.
    When unpickling, the serialized data could be manipulated to run arbitrary code.
    Instead, consider serializing the relevant data as JSON or a similar text-based
    serialization format.
  severity: WARNING
  patterns:
  - pattern: cPickle.$FUNC(...)
  - pattern-not: cPickle.$FUNC("...")
- id: avoid-dill
  mode: taint
  pattern-sources:
    - patterns:
        - pattern-either:
            - pattern-inside: >
                class $SERVER(..., http.server.BaseHTTPRequestHandler,
                ...):
                  ...
            - pattern-inside: |
                class $SERVER(..., http.server.StreamRequestHandler, ...):
                  ...
            - pattern-inside: >
                class $SERVER(..., http.server.DatagramRequestHandler,
                ...):
                  ...
        - pattern-either:
            - pattern: self.$PROPERTY
            - pattern: self.$PROPERTY.get(...)
            - pattern: self.$PROPERTY[...]
        - metavariable-regex:
            metavariable: $PROPERTY
            regex: ^(command|headers|rfile|wfile|responses|requestline|path)$
  pattern-sinks:
    - patterns:
        - focus-metavariable: $SINK
        - pattern-either:
            - patterns:
                - pattern: dill.Unpickler($SINK, ...)
            - pattern-either:
                - pattern: dill.load($SINK, ...)
                - pattern: dill.loads($SINK, ...)
                - pattern: dill.load_module(..., filename=$SINK, ...)
                - pattern: dill.load_module_asdict(..., filename=$SINK, ...)
                - pattern: dill.temp.load($SINK, ...)
                - pattern: dill.temp.load_source($SINK, ...)
                - pattern: dill.temp.loadIO($SINK, ...)
                - pattern: dill.temp.loadIO_source($SINK, ...)
  message: >-
    Insecure deserialization (called pickling in python) is when user-controllable data is deserialized by an application. 
    This potentially enables an attacker to manipulate serialized objects in order to pass harmful data into the application code.
    Many deserialization-based attacks are completed before deserialization is finished. 
    This means that the deserialization process itself can initiate an attack, even if the app's own functionality does not directly interact with the malicious object.
    
    `dill` allows arbitrary user defined classes and functions to be serialized. We do not recommend using it for unpickling data from untrusted sources.
    For deserializing data from untrusted sources we recommend using YAML or JSON libraries with built-in protections.
  metadata:
    references:
      - https://portswigger.net/web-security/deserialization
      - https://pypi.org/project/dill/
      - https://dill.readthedocs.io/en/latest/index.html
      - https://docs.python.org/3/library/pickle.html
      - https://davidhamann.de/2020/04/05/exploiting-python-pickle/
    owasp:
      - A08:2017 - Insecure Deserialization
      - A08:2021 - Software and Data Integrity Failures
    cwe:
      - "CWE-502: Deserialization of Untrusted Data"
    category: security
    technology:
      - python
      - dill
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
      - vuln
    likelihood: MEDIUM
    impact: HIGH
  languages:
    - python
  severity: ERROR
- id: avoid-shelve
  metadata:
    owasp:
    - A08:2017 - Insecure Deserialization
    - A08:2021 - Software and Data Integrity Failures
    cwe:
    - 'CWE-502: Deserialization of Untrusted Data'
    references:
    - https://docs.python.org/3/library/pickle.html
    category: security
    technology:
    - python
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
    - audit
    likelihood: LOW
    impact: MEDIUM
    confidence: MEDIUM
  languages:
  - python
  message: >-
    Avoid using `shelve`, which uses `pickle`, which is known to lead to code execution
    vulnerabilities.
    When unpickling, the serialized data could be manipulated to run arbitrary code.
    Instead, consider serializing the relevant data as JSON or a similar text-based
    serialization format.
  severity: WARNING
  pattern: shelve.$FUNC(...)
