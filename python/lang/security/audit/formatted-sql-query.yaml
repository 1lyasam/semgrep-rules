rules:
  - id: formatted-sql-query
    message: >-
      Detected possible formatted SQL query. 
      This could lead to SQL injection if user input has been used
      in the formatted SQL query. 
      Use parameterized queries instead, or sanitize user input
      thoroughly before using it in a formatted SQL query.
    metadata:
      owasp: "A1: Injection"
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
      references:
        - https://stackoverflow.com/questions/775296/mysql-parameterized-queries
      category: security
      technology:
        - python
    severity: WARNING
    languages:
      - python
    mode: taint
    pattern-sources:
    - pattern-either:
      - pattern: request.$PATH.get(...)
      - pattern: request.$PATH[...]
      - pattern: request.$FUNC
      - patterns:
        - pattern-inside: |
            @$APP.route(...)
            def $FUNC(..., $ROUTEVAR, ...):
              ...
        - pattern: $ROUTEVAR
    pattern-sinks:
    - pattern-either:
      - pattern: $DB.execute("..." % ...)
      - pattern: $DB.execute("...".format(...))
      - pattern: $DB.execute(f"...")
      - patterns:
          - pattern-either:
              - pattern-inside: |
                  $SQL = "..." % ...
                  ...
              - pattern-inside: |
                  $SQL = "...".format(...)
                  ...
              - pattern-inside: |
                  $SQL = f"...{$X}..."
                  ...
          - pattern: $DB.execute($SQL)
