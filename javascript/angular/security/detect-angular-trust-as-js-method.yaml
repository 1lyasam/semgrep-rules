rules:
- id: detect-angular-trust-as-js-method
  languages:
  - javascript
  - typescript
  message: >
    The use of $sce.trustAsJs can be dangerous if unsantiized user input flows
    through this API.
  metadata:
    category: security
    references:
    - https://docs.angularjs.org/api/ng/service/$sce#trustAsJs
    - https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20170727_AngularJS.pdf
    technology:
    - angular
  mode: taint
  pattern-sinks:
  - patterns:
    - pattern-either:
      - patterns:
        - pattern-inside: |
            $SCE_ALIAS = $sce;
            ...
            $SCE_ALIAS.$FUNC(...);
        - pattern: |
            $SCE_ALIAS.$FUNC(...);
      - pattern: |
          $sce.$FUNC(...);
    - metavariable-pattern:
        metavariable: $FUNC
        pattern-either:
        - pattern: trustAsJs
        - pattern: trustAsCss
        - pattern: trustAsHtml
  pattern-sources:
  - patterns:
    - pattern-inside: |
        $APP.controller(..., <... function(...){
        ...
        } ...>);
    - pattern: |
        $scope.$INPUT
  severity: WARNING
